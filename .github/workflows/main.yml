name: Automated API Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  api-test:
    runs-on: ubuntu-latest
    # å®šä¹‰å¯é…ç½®çš„ç¯å¢ƒå˜é‡ï¼Œç”¨æˆ·åªéœ€ä¿®æ”¹è¿™é‡Œçš„å‚æ•°
    env:
      # Apifox ç›¸å…³é…ç½®å‚æ•°
      APIFOX_PROJECT_ID: '6463434'           # Apifox é¡¹ç›®ID
      APIFOX_ENV_ID: '32377684'              # Apifox ç¯å¢ƒID
      APIFOX_TEST_RUN_COUNT: '1'             # æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œæ¬¡æ•°ï¼Œè®¾ç½®ä¸ºæ•°å­—ä»¥æ§åˆ¶é‡å¤æ‰§è¡Œæ¬¡æ•°
      # æŠ¥å‘Šç›¸å…³é…ç½®
      REPORT_DIR: './report'                 # æŠ¥å‘Šè¾“å‡ºç›®å½•
      REPORT_FORMAT: 'html'                  # æŠ¥å‘Šæ ¼å¼

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Apifox CLI
        run: npm install -g apifox-cli --unsafe-perm

      - name: Run Apifox Test
        id: run-test
        continue-on-error: true
        run: |
          set -e
          mkdir -p ${{ env.REPORT_DIR }}
          NOW=$(date +'%Y%m%d-%H%M')
          apifox run \
            --access-token ${{ secrets.APIFOX_ACCESS_TOKEN }} \
            -t ${{ env.APIFOX_PROJECT_ID }} \
            -e ${{ env.APIFOX_ENV_ID }} \
            -n ${{ env.APIFOX_TEST_RUN_COUNT }} \
            -r ${{ env.REPORT_FORMAT }} \
            --out-dir "${{ env.REPORT_DIR }}" \
            --out-file "apifox-report-${NOW}"
          echo "report_html_path=$(pwd)/${{ env.REPORT_DIR }}/apifox-report-${NOW}.html" >> $GITHUB_OUTPUT
          echo "report_filename=apifox-report-${NOW}.html" >> $GITHUB_OUTPUT
          echo "test_run_count=${{ env.APIFOX_TEST_RUN_COUNT }}" >> $GITHUB_OUTPUT

      - name: Upload HTML Report
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: apifox-html-report
          path: ${{ env.REPORT_DIR }}/apifox-report-*.html

      - name: Parse HTML Report Stats
        id: parse-html
        run: |
          REPORT_HTML="${{ steps.run-test.outputs.report_html_path }}"
          # æå–ç»Ÿè®¡æ•°æ®
          HTTP_TOTAL=$(grep -A 2 "HTTP æ¥å£è¯·æ±‚æ•°" "$REPORT_HTML" | grep -oE '[0-9]+' | head -n1)
          HTTP_FAILED=$(grep -A 2 "HTTP æ¥å£è¯·æ±‚æ•°" "$REPORT_HTML" | grep -oE '[0-9]+' | tail -n1)
          ASSERT_TOTAL=$(grep -A 2 "æ–­è¨€æ•°" "$REPORT_HTML" | grep -oE '[0-9]+' | head -n1)
          ASSERT_FAILED=$(grep -A 2 "æ–­è¨€æ•°" "$REPORT_HTML" | grep -oE '[0-9]+' | tail -n1)
          
          # æå–æµ‹è¯•åœºæ™¯ã€è¿è¡Œæ—¶é—´å’Œè¿è¡Œå·¥å…·ä¿¡æ¯
          # æå–æµ‹è¯•åœºæ™¯
          TEST_SCENARIO=$(grep -A 2 "æµ‹è¯•åœºæ™¯" "$REPORT_HTML" | grep -A 1 "<div class=\"col-md-4 text-label\">æµ‹è¯•åœºæ™¯</div>" | grep -o '<div class=\"col-md-8\">[^<]*</div>' | sed 's/<[^>]*>//g' | tr -d '[:space:]')
          if [ -z "$TEST_SCENARIO" ]; then
            TEST_SCENARIO="N/A"
          fi
          
          # æå–è¿è¡Œæ—¶é—´å¹¶ä¿®å¤æ ¼å¼é—®é¢˜ï¼Œæ·»åŠ æ­£ç¡®çš„æ—¶åŒºåç§»
          RUN_TIME=$(grep -A 2 "è¿è¡Œæ—¶é—´" "$REPORT_HTML" | grep -A 1 "<div class=\"col-md-4 text-label\">è¿è¡Œæ—¶é—´</div>" | grep -o '<div class=\"col-md-8\">[^<]*</div>' | sed 's/<[^>]*>//g' | tr -d '[:space:]')
          if [ -z "$RUN_TIME" ]; then
            RUN_TIME="N/A"
          else
            # æå–æ—¥æœŸéƒ¨åˆ†å’Œæ—¶é—´éƒ¨åˆ†
            DATE_PART=$(echo "$RUN_TIME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})/\1/')
            TIME_PART=$(echo "$RUN_TIME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})/\2/')
            
            # å¦‚æœæå–æˆåŠŸï¼Œæ·»åŠ 8å°æ—¶å¹¶æ ¼å¼åŒ–
            if [ -n "$DATE_PART" ] && [ -n "$TIME_PART" ]; then
              # è½¬æ¢ä¸ºUTC+8æ—¶é—´ï¼Œä½¿ç”¨GNU dateå‘½ä»¤
              UTC_PLUS_8_TIME=$(date -d "$DATE_PART $TIME_PART UTC +8 hours" +"%Y-%m-%d %H:%M:%S")
              RUN_TIME="$UTC_PLUS_8_TIME UTC+8"
            else
              # æ ¼å¼ä¸åŒ¹é…æ—¶ï¼Œä¿ç•™åŸå§‹å€¼å¹¶æ·»åŠ UTC+0æ ‡è¯†
              RUN_TIME="$RUN_TIME UTC+0"
            fi
          fi
          
          # æå–è¿è¡Œå·¥å…·
          RUN_TOOL=$(grep -A 2 "è¿è¡Œå·¥å…·" "$REPORT_HTML" | grep -A 1 "<div class=\"col-md-4 text-label\">è¿è¡Œå·¥å…·</div>" | grep -o '<div class=\"col-md-8\">[^<]*</div>' | sed 's/<[^>]*>//g' | tr -d '[:space:]')
          if [ -z "$RUN_TOOL" ]; then
            RUN_TOOL="N/A"
          fi
          
          # åŸºäºHTMLæŠ¥å‘Šå®é™…æ ¼å¼æ”¹è¿›çš„æ€»è€—æ—¶æå–æ–¹æ³•
          # æ–¹æ³•1ï¼šç›´æ¥åŒ¹é…divç»“æ„ï¼Œæ‰¾åˆ°åŒ…å«"æ€»è€—æ—¶"çš„divåé¢çš„divå†…å®¹
          DURATION=$(grep -A 2 "æ€»è€—æ—¶" "$REPORT_HTML" | grep -A 1 "<div class=\"col-md-4 text-label\">æ€»è€—æ—¶</div>" | grep -o '<div class=\"col-md-8\">[^<]*</div>' | sed 's/<[^>]*>//g' | tr -d '[:space:]')
          
          # æ–¹æ³•2ï¼šå¦‚æœç¬¬ä¸€ç§æ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼æå–
          if [ -z "$DURATION" ]; then
            # æŸ¥æ‰¾åŒ…å«"æ€»è€—æ—¶"çš„è¡Œï¼Œè·å–ä¸‹ä¸€è¡Œå†…å®¹ï¼Œç„¶åæå–æ•°å­—å’Œå•ä½
            DURATION=$(grep -A 1 "æ€»è€—æ—¶" "$REPORT_HTML" | grep -o '[0-9]\+\.[0-9]\+[a-zA-Z]\?\|[0-9]\+[a-zA-Z]\?')
          fi
          
          # æ–¹æ³•3ï¼šå¦‚æœä»ç„¶å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ›´ç›´æ¥çš„æ–¹å¼
          if [ -z "$DURATION" ]; then
            # æå–æ‰€æœ‰divå†…å®¹ï¼Œç„¶åæ‰¾åˆ°æ€»è€—æ—¶åé¢çš„å€¼
            DURATION=$(grep -A 1 "æ€»è€—æ—¶" "$REPORT_HTML" | grep "col-md-8" | sed 's/<[^>]*>//g' | tr -d '[:space:]')
          fi
          
          # å¦‚æœä»ç„¶å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤å€¼
          if [ -z "$DURATION" ]; then
            DURATION="N/A"
          fi
          
          echo "http_total=$HTTP_TOTAL" >> $GITHUB_OUTPUT
          echo "http_failed=$HTTP_FAILED" >> $GITHUB_OUTPUT
          echo "assert_total=$ASSERT_TOTAL" >> $GITHUB_OUTPUT
          echo "assert_failed=$ASSERT_FAILED" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "test_scenario=$TEST_SCENARIO" >> $GITHUB_OUTPUT
          echo "run_time=$RUN_TIME" >> $GITHUB_OUTPUT
          echo "run_tool=$RUN_TOOL" >> $GITHUB_OUTPUT

      - name: Send Test Report to Feishu
        if: always()
        env:
          ARTIFACT_URL: "${{ steps.upload-artifact.outputs.artifact-url }}"
        run: |
          FEISHU_MSG_TITLE="ğŸš€ Apifox æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ"
          REPORT_FILENAME="${{ steps.run-test.outputs.report_filename }}"
          TEST_RUN_COUNT="${{ steps.run-test.outputs.test_run_count }}"
          HTTP_TOTAL="${{ steps.parse-html.outputs.http_total }}"
          HTTP_FAILED="${{ steps.parse-html.outputs.http_failed }}"
          ASSERT_TOTAL="${{ steps.parse-html.outputs.assert_total }}"
          ASSERT_FAILED="${{ steps.parse-html.outputs.assert_failed }}"
          DURATION="${{ steps.parse-html.outputs.duration }}"
          TEST_SCENARIO="${{ steps.parse-html.outputs.test_scenario }}"
          RUN_TIME="${{ steps.parse-html.outputs.run_time }}"
          RUN_TOOL="${{ steps.parse-html.outputs.run_tool }}"

          # é£ä¹¦å†…å®¹åˆ†è¡Œå¯Œæ–‡æœ¬ï¼Œæ¯è¡Œç‹¬ç«‹ tagï¼ŒæŠ¥å‘Šä¸‹è½½é“¾æ¥ç²¾ç¡®åˆ° artifact-id
          FEISHU_CONTENT_JSON=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status "æ‰§è¡Œå®Œæˆ" \
            --arg duration "$DURATION" \
            --arg http_total "$HTTP_TOTAL" \
            --arg http_failed "$HTTP_FAILED" \
            --arg assert_total "$ASSERT_TOTAL" \
            --arg assert_failed "$ASSERT_FAILED" \
            --arg test_run_count "$TEST_RUN_COUNT" \
            --arg url "$ARTIFACT_URL" \
            --arg filename "$REPORT_FILENAME" \
            --arg test_scenario "$TEST_SCENARIO" \
            --arg run_time "$RUN_TIME" \
            --arg run_tool "$RUN_TOOL" \
            '[
              [{tag:"text", text:"ğŸ“¦ ä»“åº“: "},{tag:"text", text:$repo}],
              [{tag:"text", text:"ğŸ”– åˆ†æ”¯: "},{tag:"text", text:$branch}],
              [{tag:"text", text:"ğŸ§ª çŠ¶æ€: "},{tag:"text", text:$status}],
              [{tag:"text", text:"ğŸ“‹ æµ‹è¯•åœºæ™¯: "},{tag:"text", text:$test_scenario}],
              [{tag:"text", text:"â° è¿è¡Œæ—¶é—´: "},{tag:"text", text:$run_time}],
              [{tag:"text", text:"ğŸ”§ è¿è¡Œå·¥å…·: "},{tag:"text", text:$run_tool}],
              [{tag:"text", text:"æ€»è€—æ—¶: "},{tag:"text", text:$duration}],
              [{tag:"text", text:"æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œæ¬¡æ•°: "},{tag:"text", text:$test_run_count}],
              [{tag:"text", text:"HTTPæ¥å£æ€»æ•°: "},{tag:"text", text:$http_total}],
              [{tag:"text", text:"HTTPæ¥å£å¤±è´¥æ•°: "},{tag:"text", text:$http_failed}],
              [{tag:"text", text:"æ–­è¨€æ€»æ•°: "},{tag:"text", text:$assert_total}],
              [{tag:"text", text:"æ–­è¨€å¤±è´¥æ•°: "},{tag:"text", text:$assert_failed}],
              [{tag:"text", text:"æŠ¥å‘Šä¸‹è½½åœ°å€: "},{tag:"a", text:"ç‚¹å‡»ä¸‹è½½HTMLæŠ¥å‘Š", href:$url}],
              [{tag:"text", text:"æŠ¥å‘Šæ–‡ä»¶å: "},{tag:"text", text:$filename}]
            ]'
          )

          JSON_PAYLOAD=$(jq -n \
            --arg title "$FEISHU_MSG_TITLE" \
            --argjson content "$FEISHU_CONTENT_JSON" \
            '{
              msg_type: "post",
              content: {
                post: {
                  zh_cn: {
                    title: $title,
                    content: $content
                  }
                }
              }
            }'
          )

          if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD"
          fi